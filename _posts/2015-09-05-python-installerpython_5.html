---
layout: post
title: 從Python Installer打包程式拖出Python程式碼
date: '2015-09-05T00:34:00.002-07:00'
author: 聖豪馬
tags:
- Crack
- Python
modified_time: '2015-09-05T00:35:02.392-07:00'
thumbnail: http://4.bp.blogspot.com/-dXoBPrbmS0s/VeqPFDX2z3I/AAAAAAAAHLE/BTK40JIft1c/s72-c/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25882.43.38.png
blogger_id: tag:blogger.com,1999:blog-1335849442109808564.post-146225842751299640
blogger_orig_url: http://helloadr.blogspot.com/2015/09/python-installerpython_5.html
---

<b><span style="font-size: x-large;">卡關T__T</span></b><br /><br />登愣，之前卡關很久的FireEye的Python題目<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://www.blogger.com/blogger.g?blogID=1335849442109808564" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"></a><a href="http://4.bp.blogspot.com/-dXoBPrbmS0s/VeqPFDX2z3I/AAAAAAAAHLE/BTK40JIft1c/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25882.43.38.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="412" src="http://4.bp.blogspot.com/-dXoBPrbmS0s/VeqPFDX2z3I/AAAAAAAAHLE/BTK40JIft1c/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25882.43.38.png" width="640" /></a></div>根據Icon可以大概推知這支Python程式透過Python  Installer來打包（畢竟Python能打包成.exe的工具不多XD）後來得知有個開源工具可以替我們撈出Source Code：  PyInstaller Extractor（後來查了一下這套工具在國外好像蠻有名的 可以看此篇 <a href="http://sysforensics.org/2015/04/unpacking-pyinstaller-packed-python-malware/">Unpacking Pyinstaller Packed Python Malware</a>）<br />那麼工具載點在這裡：<a href="http://sourceforge.net/projects/pyinstallerextractor/">PyInstaller Extractor Source</a>，載回來後可以得到一個PyInstxtractor.py<br />底下紀錄如何操作這套.py工具<br /><br /><br /><b><span style="font-size: x-large;">手術台</span></b><br /><br />今天你獲得了一個Python Installer包裝好的程式（這邊拿的是Fire Eye的flare-on題目第三題 elfie.exe）那要怎麼透過PyInstxtractor.py替我們撈出Source呢？<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-XVlpTEX89XE/VeqaRJAlCUI/AAAAAAAAHLo/ESEcz1jGDk0/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.01.21.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="448" src="http://4.bp.blogspot.com/-XVlpTEX89XE/VeqaRJAlCUI/AAAAAAAAHLo/ESEcz1jGDk0/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.01.21.png" width="640" /></a></div><br />只要看到以上字串就表示解析成功了，接著回到你的執行目錄之下可以看到：<br /><a href="http://2.bp.blogspot.com/-Rv71nvYkTVw/VeqTbMUJv9I/AAAAAAAAHLQ/iEj0IVO1980/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.03.09.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="465" src="http://2.bp.blogspot.com/-Rv71nvYkTVw/VeqTbMUJv9I/AAAAAAAAHLQ/iEj0IVO1980/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.03.09.png" width="640" /></a><br />會看到在目錄之下會產生很多從這個elfie.exe解析出來的區段文件，其他基本上都是包入的runtime，比較重要的是跟程式同名的文件（如在此篇解析出來就會是elfie）打開來看看<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-8pLTNZ05q_k/VeqaYnOiFhI/AAAAAAAAHLw/-J9-h1wVdhE/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.06.28.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="412" src="http://2.bp.blogspot.com/-8pLTNZ05q_k/VeqaYnOiFhI/AAAAAAAAHLw/-J9-h1wVdhE/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.06.28.png" width="640" /></a></div><br />打開此文件後可以看到它其實是個Python腳本，不過你會看到相當大量的莫名其妙的Base64的Code，最後底下Import base64在做exec(base64.b64decode(...一堆base64...))，尾巴會有個NUL。<br /><br />這裏我們可以得知這隻打包好的程式被跑起來時，Script會把透過exec()來執行Python的程式碼執行起來，在此我們可以看到被執行的程式碼其實也就是base64.b64decode(...一堆base64...)這段了，所以我們只要設法把這段程式碼Print出來就可以了。<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-AjVX90CJSvo/VeqahsjyZZI/AAAAAAAAHL4/DpQnwE0CJDY/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.30.28.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="417" src="http://3.bp.blogspot.com/-AjVX90CJSvo/VeqahsjyZZI/AAAAAAAAHL4/DpQnwE0CJDY/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.30.28.png" width="640" /></a></div><br /><br />所以我們可以手動修改一下這段程式碼，把底下NUL的部分刪掉，然後把exec()改成Print()<br />然後我們再回到終端機下把這個elfie文件當作Python Script跑起來看看：<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://www.blogger.com/blogger.g?blogID=1335849442109808564" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"></a><a href="https://www.blogger.com/blogger.g?blogID=1335849442109808564" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"></a><a href="http://1.bp.blogspot.com/-iVs3T7w41gk/Veqa46H0sdI/AAAAAAAAHMA/yUC5JsJG0f0/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.35.37.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="448" src="http://1.bp.blogspot.com/-iVs3T7w41gk/Veqa46H0sdI/AAAAAAAAHMA/yUC5JsJG0f0/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.35.37.png" width="640" /></a></div><br /><br />接著到執行目錄下看看Code.txt：<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-YQs5dYpcQ6w/VeqbA4yZ63I/AAAAAAAAHMI/u7DR3QUDYqk/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.19.06.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="418" src="http://2.bp.blogspot.com/-YQs5dYpcQ6w/VeqbA4yZ63I/AAAAAAAAHMI/u7DR3QUDYqk/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2015-09-05%2B%25E4%25B8%258B%25E5%258D%25883.19.06.png" width="640" /></a></div><br />&nbsp;就可以看到程式碼囉（不過上面那段Base64又是需要再做一次反轉，這層開始就是Python Code了）<br /><br />